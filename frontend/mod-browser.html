<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MCmadeEasy - Mod Browser</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&display=swap" rel="stylesheet">
<style>
:root{
  --bg: #050505;
  --card: rgba(20, 20, 20, 0.6);
  --border: rgba(255, 255, 255, 0.08);
  --accent: #8b5cf6;
  --accent-glow: rgba(139, 92, 246, 0.4);
  --text: #ffffff;
  --text-muted: #a1a1aa;
  --danger: #ef4444;
  --success: #10b981;
}
body{
  margin:0;
  background:var(--bg);
  font-family:'Inter',sans-serif;
  color:var(--text);
  height:100vh;
  overflow:hidden;
}
header{
  padding:15px 25px;
  border-bottom:1px solid var(--border);
  display:flex;
  justify-content:space-between;
  align-items:center;
  background:rgba(5,5,5,0.9);
  backdrop-filter:blur(10px);
}
.logo{
  font-weight:600;
  font-size:16px;
  color:var(--accent);
  letter-spacing:1px;
}
.server-info{
  background:var(--card);
  padding:8px 15px;
  border-radius:20px;
  font-size:12px;
  color:var(--text-muted);
  border:1px solid var(--border);
}
.server-info strong{
  color:var(--accent);
}
.topbar{
  display:flex;
  gap:10px;
  padding:15px 25px;
  background:rgba(5,5,5,0.5);
  border-bottom:1px solid var(--border);
}
input,select{
  background:var(--card);
  border:1px solid var(--border);
  padding:10px 14px;
  border-radius:8px;
  color:white;
  min-width:150px;
  font-size:13px;
  outline:none;
  transition:border-color 0.2s;
}
input:focus,select:focus{
  border-color:var(--accent);
}
button{
  background:var(--accent);
  border:none;
  padding:10px 16px;
  border-radius:8px;
  font-weight:500;
  cursor:pointer;
  transition:all 0.2s;
  font-size:13px;
  color:white;
}
button:hover{
  background:#7c3aed;
  transform:translateY(-1px);
  box-shadow:0 4px 12px var(--accent-glow);
}
.grid{
  padding:20px 25px;
  display:grid;
  grid-template-columns:repeat(auto-fill,minmax(250px,1fr));
  gap:18px;
  overflow-y:auto;
  height:calc(100vh - 180px);
  padding-bottom:80px;
}
.card{
  background:var(--card);
  border:1px solid var(--border);
  border-radius:12px;
  padding:15px;
  padding-top:20px;
  transition:all 0.25s;
  display:flex;
  flex-direction:column;
  position:relative;
}
.card:hover{
  border-color:var(--accent);
  box-shadow:0 0 20px var(--accent-glow);
  transform:translateY(-2px);
}
.card img{
  width:100%;
  height:120px;
  object-fit:cover;
  border-radius:8px;
  margin-bottom:10px;
}
.card h3{
  margin:4px 0;
  font-size:14px;
  font-weight:500;
}
.card p{
  font-size:11px;
  color:var(--text-muted);
  min-height:30px;
  line-height:1.4;
}
.tags{
  margin-top:8px;
  display:flex;
  flex-wrap:wrap;
  gap:4px;
}
.tag{
  display:inline-block;
  background:rgba(139,92,246,0.2);
  padding:2px 8px;
  border-radius:12px;
  font-size:9px;
  color:var(--accent);
}
.tag-fabric{background:rgba(233,183,88,0.3);color:#e9b758;}
.tag-forge{background:rgba(243,152,56,0.3);color:#f39838;}
.tag-quilt{background:rgba(200,55,135,0.3);color:#c83787;}
.tag-neoforge{background:rgba(38,83,135,0.3);color:#265387;}
.tag-paper{background:rgba(240,240,240,0.2);color:#f0f0f0;}
.tag-spigot{background:rgba(240,101,28,0.3);color:#f0651c;}
.tag-bukkit{background:rgba(161,0,0,0.3);color:#a10000;}
.tag-purpur{background:rgba(102,51,153,0.3);color:#663399;}
.tag-vanilla{background:rgba(120,120,120,0.3);color:#787878;}
.install-btn{
  margin-top:auto;
  background:var(--accent);
  width:100%;
}
.install-btn:hover{
  background:#7c3aed;
}
#pagination{
  position:fixed;
  bottom:0;
  left:0;
  right:0;
  display:flex;
  justify-content:center;
  align-items:center;
  gap:15px;
  padding:15px;
  background:rgba(5,5,5,0.95);
  border-top:1px solid var(--border);
  z-index:100;
}
#pagination.hidden{
  display:none;
}

.modal{
  position:fixed;
  inset:0;
  background:rgba(0,0,0,0.8);
  backdrop-filter:blur(8px);
  display:none;
  justify-content:center;
  align-items:center;
  z-index:999;
}
.modal-content{
  width:600px;
  max-height:80vh;
  overflow:auto;
  background:rgba(20,20,20,0.95);
  border:1px solid var(--border);
  border-radius:16px;
  padding:25px;
}
.version-card{
  background:var(--card);
  border:1px solid var(--border);
  padding:15px;
  border-radius:12px;
  margin-bottom:12px;
}
.version-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:10px;
}
.version-header strong{
  font-size:13px;
}
.dep{
  color:#fbbf24;
  font-size:11px;
  margin-top:10px;
}
.no-dep{
  color:var(--text-muted);
  font-size:11px;
  margin-top:10px;
}
.btn-green{
  background:var(--success);
  color:#000;
}
.btn-green:hover{
  background:#059669;
}
.btn-grey{
  background:#374151;
  color:#6b7280;
  cursor:not-allowed;
}
.btn-installed{
  background:rgba(139,92,246,0.3);
  color:var(--accent);
  border:1px solid var(--accent);
  cursor:default;
}
.btn-close{
  background:rgba(255,255,255,0.1);
  float:right;
}
.btn-close:hover{
  background:rgba(255,255,255,0.2);
}
.loading{
  text-align:center;
  color:var(--text-muted);
  padding:60px;
  font-size:14px;
}
.installed-badge{
  background:var(--success);
  color:#000;
  padding:3px 8px;
  border-radius:6px;
  font-size:10px;
  font-weight:600;
  margin-left:8px;
}
.card-installed{
  position:relative !important;
}
.card-installed::after{
  content:'✓';
  position:absolute;
  top:8px;
  right:8px;
  background:#10b981;
  color:#000;
  width:22px;
  height:22px;
  border-radius:50%;
  display:flex;
  align-items:center;
  justify-content:center;
  font-size:12px;
  font-weight:bold;
  z-index:10;
}
::-webkit-scrollbar{
  width:8px;
}
::-webkit-scrollbar-track{
  background:transparent;
}
::-webkit-scrollbar-thumb{
  background:rgba(255,255,255,0.1);
  border-radius:4px;
}
::-webkit-scrollbar-thumb:hover{
  background:rgba(255,255,255,0.2);
}
</style>
</head>

<body>

<header>
  <div class="logo">MOD BROWSER</div>
</header>

<div class="topbar">
  <input id="search" placeholder="Search..." style="flex:1;" />
  <input id="mcversion" placeholder="MC Version (1.20.1)" style="width:120px;" />
  <select id="contentType" onchange="onContentTypeChange()" style="width:100px;">
    <option value="mods">Mods</option>
    <option value="plugins">Plugins</option>
  </select>
  <button onclick="searchProjects()">Search</button>
  <div class="server-info" id="serverInfo" style="margin-left:10px;">Server: <strong>Not selected</strong></div>
</div>

<div class="grid" id="results">
  <div class="loading">Enter a Minecraft version and search for mods/plugins</div>
</div>

<div class="pagination hidden" id="pagination">
  <button onclick="prevPage()">Prev</button>
  <span id="pageNum" style="color:var(--text-muted);">Page 1</span>
  <button onclick="nextPage()">Next</button>
</div>

<div class="modal" id="versionModal">
  <div class="modal-content">
    <button class="btn-close" onclick="closeModal()">✕</button>
    <h3 style="margin:10px 0 15px;">Select Version</h3>
    <div id="versionList"></div>
  </div>
</div>

<script>
let currentPage=1;
const limit=12;
let currentModProjectId = null;
let allVersionsData = [];

const urlParams = new URLSearchParams(window.location.search);
const serverVersion = urlParams.get('version') || '';
const profileName = urlParams.get('profile') || '';
const serverSoftware = urlParams.get('software') || '';

function getDefaultContentType() {
  if(!serverSoftware) return 'mods';
  const s = serverSoftware.toLowerCase();
  if(['fabric','forge','quilt','neoforge'].includes(s)) return 'mods';
  return 'plugins';
}

function getContentTypeLabel() {
  const type = document.getElementById('contentType').value;
  return type === 'plugins' ? 'Plugins' : 'Mods';
}

function updateServerInfo() {
  const type = getContentTypeLabel();
  const label = type === 'Plugins' ? 'Paper/Spigot' : 'Fabric/Forge';
  document.getElementById('serverInfo').innerHTML = `Server: <strong>${profileName || 'Unknown'}</strong> (${label})`;
}

function onContentTypeChange() {
  updateServerInfo();
  searchProjects();
}

if(serverVersion){
  document.getElementById('mcversion').value = serverVersion;
  document.getElementById('contentType').value = getDefaultContentType();
  updateServerInfo();
}

async function searchProjects(){
  currentPage=1;
  loadProjects();
}

function getServerSoftwareType(software) {
  if(!software) return 'mods';
  const s = software.toLowerCase();
  if(['fabric','forge','quilt','neoforge'].includes(s)) return 'mods';
  return 'plugins';
}

async function loadProjects(){
  const query=document.getElementById("search").value;
  const mcVersion=document.getElementById("mcversion").value;
  const contentType=document.getElementById("contentType").value;
  const offset=(currentPage-1)*limit;

  const grid=document.getElementById("results");
  grid.innerHTML="<div class='loading'>Loading...</div>";

  if(!mcVersion){
    grid.innerHTML="<div class='loading'>Please enter a Minecraft version</div>";
    return;
  }

  let facets=[];
  if(contentType==='plugins'){
    facets=[["project_type:mod"],["categories:spigot"],["categories:paper"],["categories:bukkit"],["categories:purpur"]];
  }else{
    facets=[["project_type:mod"]];
  }
  facets.push(["versions:"+mcVersion]);

  const url=`https://api.modrinth.com/v2/search?query=${query}&limit=${limit}&offset=${offset}&facets=${encodeURIComponent(JSON.stringify(facets))}`;

  const res=await fetch(url);
  const data=await res.json();

  grid.innerHTML="";

  if(data.hits.length===0){
    grid.innerHTML="<div class='loading'>No "+contentType+" found for version "+mcVersion+"</div>";
    return;
  }

  document.getElementById('pagination').classList.remove('hidden');

  let installedMods = [];
  if(profileName){
    try {
      const installedRes = await fetch(`http://localhost:8001/mods/${profileName}`);
      installedMods = await installedRes.json();
    } catch(e){}
  }

  const installedNames = installedMods.map(m => m.name.toLowerCase());

  data.hits.forEach(mod=>{
    const isInstalled = installedNames.some(name => mod.title.toLowerCase().includes(name) || name.includes(mod.title.toLowerCase()));
    const card=document.createElement("div");
    card.className="card" + (isInstalled ? " card-installed" : "");
    card.style.cssText = "position:relative;" + (isInstalled ? "border-color:#10b981;" : "");
    const badgeHtml = isInstalled ? '<span style="position:absolute;top:8px;right:8px;background:#10b981;color:#000;width:22px;height:22px;border-radius:50%;display:flex;align-items:center;justify-content:center;font-size:12px;font-weight:bold;z-index:10;">✓</span>' : '';
    card.innerHTML=`
      ${badgeHtml}
      <img src="${mod.icon_url || 'https://via.placeholder.com/300'}">
      <h3>${mod.title}</h3>
      <p>${(mod.description || '').substring(0,80)}</p>
      <div class="tags">
        ${(mod.versions||[]).slice(0,4).map(v=>`<span class="tag">${v}</span>`).join("")}
      </div>
      <button class="install-btn" onclick="openVersions('${mod.project_id}')">${isInstalled ? 'Installed' : 'View Versions'}</button>
    `;
    grid.appendChild(card);
  });

  document.getElementById("pageNum").innerText="Page "+currentPage+" of "+Math.ceil(data.total_hits/limit);
}

async function openVersions(projectId){
  currentModProjectId = projectId;
  const mcFilter=document.getElementById("mcversion").value;
  
  const res=await fetch(`https://api.modrinth.com/v2/project/${projectId}/version`);
  allVersionsData = await res.json();

  let installedMods = [];
  if(profileName){
    try {
      const installedRes = await fetch(`http://localhost:8001/mods/${profileName}`);
      installedMods = await installedRes.json();
    } catch(e){}
  }
  const installedFiles = installedMods.map(m => m.file);

  const list=document.getElementById("versionList");
  list.innerHTML="";

  for(const v of allVersionsData){
    const isMatch = v.game_versions && v.game_versions.includes(mcFilter);
    const filename = v.files[0] ? v.files[0].filename : '';
    const isInstalled = installedFiles.includes(filename);
    
    let depText = '';
    if(v.dependencies && v.dependencies.length > 0){
      const depIds = v.dependencies.map(d => d.project_id).filter(id => id);
      if(depIds.length > 0){
        try {
          const depRes = await fetch(`https://api.modrinth.com/v2/projects?ids=${encodeURIComponent(JSON.stringify(depIds))}`);
          const depData = await depRes.json();
          if(depData && depData.length > 0){
            depText = '<div class="dep">Dependencies: ' + depData.map(d => d.title).join(', ') + '</div>';
          }
        } catch(e){}
      }
      if(!depText){
        depText = '<div class="no-dep">No dependencies</div>';
      }
    } else {
      depText = '<div class="no-dep">No dependencies</div>';
    }

    let btnClass = isMatch ? 'btn-green' : 'btn-grey';
    let btnText = isMatch ? 'Download' : 'Wrong Version';
    let btnAction = isMatch ? `downloadMod('${v.files[0].url}', '${v.files[0].filename}', '${v.name}')` : '';
    let btnDisabled = '';
    
    if(isInstalled){
      btnClass = 'btn-installed';
      btnText = 'Installed';
      btnAction = '';
      btnDisabled = 'disabled';
    }
    
    const div=document.createElement("div");
    div.className="version-card";
    const getLoaderClass = (l) => {
      const ll = l.toLowerCase();
      if(ll.includes('fabric')) return 'tag-fabric';
      if(ll.includes('forge')) return 'tag-forge';
      if(ll.includes('quilt')) return 'tag-quilt';
      if(ll.includes('neoforge')) return 'tag-neoforge';
      if(ll.includes('paper')) return 'tag-paper';
      if(ll.includes('spigot')) return 'tag-spigot';
      if(ll.includes('bukkit')) return 'tag-bukkit';
      if(ll.includes('purpur')) return 'tag-purpur';
      return '';
    };
    div.innerHTML = `
      <div class="version-header">
        <strong>${v.name}${isInstalled ? ' ✓' : ''}</strong>
        <button class="${btnClass}" onclick="${btnAction}" ${btnDisabled}>${btnText}</button>
      </div>
      <div class="tags">${(v.game_versions||[]).map(ver=>`<span class="tag" style="${ver===mcFilter?'background:var(--accent);color:#fff':''}">${ver}</span>`).join("")}</div>
      <div class="tags">${(v.loaders||[]).map(l=>`<span class="tag ${getLoaderClass(l)}">${l}</span>`).join("")}</div>
      ${depText}
    `;
    list.appendChild(div);
  }

  document.getElementById("versionModal").style.display="flex";
}

async function downloadMod(url, filename, modName){
  if(!profileName){
    alert('No server profile selected');
    return;
  }

  try {
    const res = await fetch(`http://localhost:8001/mods/${profileName}/install`, {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({url: url, name: modName})
    });
    const result = await res.json();
    
    if(result.success){
      alert(`Successfully installed: ${modName}\nFile: ${filename}`);
      closeModal();
      loadProjects();
    } else {
      alert('Failed to install: ' + (result.error || 'Unknown error'));
    }
  } catch(e){
    alert('Error installing mod. Make sure the server is running.');
  }
}

function closeModal(){
  document.getElementById("versionModal").style.display="none";
}

function nextPage(){
  currentPage++;
  loadProjects();
}

function prevPage(){
  if(currentPage>1){
    currentPage--;
    loadProjects();
  }
}

if(serverVersion){
  loadProjects();
}
</script>

</body>
</html>
